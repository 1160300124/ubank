<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 
	namespace：必须与对应的接口全类名一致
	id:必须与对应接口的某个对应的方法名一致
	
 -->
<mapper namespace="com.ulaiber.web.dao.AnnouncementDao">

    <resultMap id="AnnouncementMap" type="Announcement" >
    	<id column="aid" property="aid" jdbcType="BIGINT" />
    	<result column="company_id" property="companyId" jdbcType="BIGINT" />
    	<result column="company_name" property="companyName" jdbcType="VARCHAR" />
    	<result column="announce_title" property="announceTitle" jdbcType="VARCHAR" />
    	<result column="create_time" property="createTime" jdbcType="VARCHAR" />
    	<result column="announce_count" property="announceCount" jdbcType="VARCHAR" />
    	<result column="announce_body" property="announceBody" jdbcType="VARCHAR" />
    	<result column="operate_user_id" property="operateUserId" jdbcType="BIGINT" />
    	<result column="operate_user_name" property="operateUserName" jdbcType="VARCHAR" />
   </resultMap>
  
	 <!-- mybsits_config中配置的alias类别名,也可直接配置resultType为类路劲 -->  
	<insert id="save" parameterType="Announcement" useGeneratedKeys="true" keyProperty="aid">
		insert into tbl_announcements(company_id,company_name,announce_title,create_time,announce_count,announce_body,operate_user_id,operate_user_name) values
		(#{companyId},#{companyName},#{announceTitle},#{createTime},#{announceCount},#{announceBody},#{operateUserId},#{operateUserName}) 
	</insert>
	
	<select id="getAnnouncements" resultMap="AnnouncementMap">
		select * from tbl_announcements order by create_time desc limit #{offset},#{limit}
		<if test="companyId != null and companyId != ''">
			where companyId=#{companyId}
		</if>
	</select>

	<select id="getTotalCount" parameterType="Long" resultType="Integer">
		select count(1) from tbl_announcements 
		<if test="companyId != null and companyId != ''">
			where companyId=#{companyId}
		</if>
	</select>
	
	<select id="getAnnouncementByAid" parameterType="Long" resultMap="AnnouncementMap">
		select * from tbl_announcements where aid=#{aid}
	</select>
	
	<delete id="deleteByAid" parameterType="Long">
	  	delete from tbl_announcements where aid=#{aid}
	</delete>
	
	<insert id="batchInsertUserOfAnnouncement" parameterType="java.util.List">
		insert into tbl_users_of_announcements(userId,aid,deptId,companyId) values
		<foreach collection ="list" item="ua" index= "index" separator =",">
             (#{ua.userId}, #{ua.aid}, #{ua.deptId}, #{ua.companyId})
        </foreach >
	</insert>
	
	<insert id="batchDeleteUserOfAnnouncement" parameterType="java.util.List">
		delete from tbl_users_of_announcements where userId in
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">   
	        #{item}   
	    </foreach> 
	</insert>
	
	<delete id="deleteUserOfAnnouncementByAid" parameterType="Long">
		delete from tbl_users_of_announcements where aid=#{aid}
	</delete>
	
	<select id="getUserIdsByRid" parameterType="Long" resultType="com.ulaiber.web.model.announcement.UserOfAnnouncement">
		select * from tbl_users_of_announcements a join tbl_users u on a.userid=u.user_id where u.disabled='0' and aid=#{aid}
	</select>
	
	<select id="getAnnouncementsByUserId" resultType="java.util.Map">
		select a.aid,a.create_time,a.announce_title,a.announce_body from tbl_announcements a join tbl_users_of_announcements ua on a.aid=ua.aid where ua.userId=#{userId} 
		order by a.create_time desc limit #{offset},#{limit}
	</select>
	
	<select id="getTotalCountByUserId" resultType="Integer">
		select count(1) from tbl_announcements a join tbl_users_of_announcements ua on a.aid=ua.aid where ua.userId=#{userId} 
	</select>
	
	<insert id="batchInsertAttachments" parameterType="java.util.List">
		insert into tbl_announcements_attachments(aid,attachment_name,attachment_type,attachment_size,attachment_path) values
		<foreach collection ="list" item="att" index= "index" separator =",">
             (#{att.aid}, #{att.attachment_name}, #{att.attachment_type}, #{att.attachment_size}, #{att.attachment_path})
        </foreach >
	</insert>
	
	<delete id="deleteAttachmentsByAid" parameterType="Long">
		delete from tbl_announcements_attachments where aid=#{aid}
	</delete>
	
	<select id="getAttachmentCountByUserId" resultType="java.util.Map">
		select aa.aid,count(1) total from tbl_announcements_attachments aa join tbl_users_of_announcements ua on ua.aid=aa.aid where ua.userId=#{userId} group by aa.aid
	</select>
	
	<select id="getAttachmentsByAid" parameterType="Long" resultType="com.ulaiber.web.model.announcement.Attachment">
		select * from tbl_announcements_attachments where aid=#{aid}
	</select>
	
</mapper>