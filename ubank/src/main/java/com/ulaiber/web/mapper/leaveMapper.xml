<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	namespace：必须与对应的接口全类名一致
	id:必须与对应接口的某个对应的方法名一致

 -->
<mapper namespace="com.ulaiber.web.dao.LeaveDao">

    <resultMap id="LeaveRecordMap" type="com.ulaiber.web.model.LeaveRecord" >
        <id property="id" column="id" jdbcType="BIGINT" />
    </resultMap>

    <!--申请请假-->
    <insert id="saveLeaveRecord" parameterType="com.ulaiber.web.model.LeaveRecord" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tbl_leave_record (userid,leaveType,startDate,endDate,startType,endType,restDay,leaveTime,realLeaveTime,
                  auditor,reason,createDate,status,disable,type)
            VALUES (#{userid},#{leaveType},#{startDate},#{endDate},#{startType},#{endType},#{restDay},#{leaveTime},#{realLeaveTime},
                  #{auditor},#{reason},#{createDate},'0','0','0')
    </insert>

    <!--查询个人申请记录-->
    <select id="queryApplyRecord" parameterType="Map" resultType="com.ulaiber.web.model.ApplyForVO">
        SELECT  a.id,a.userid,a.leaveType,a.startDate,a.endDate,a.leaveTime,a.auditor,a.reason,a.createDate,a.startType,a.endType,a.restDay,
          a.currentAuditor,a.disable,a.type,a.status,b.user_name as username,b.image,d.morning,d.afternoon,d.type as remedyType,d.remedyDate
            FROM tbl_leave_record a left join tbl_overtime_details c on a.id = c.recordNo
                left join tbl_users b on a.userid = b.user_id
                left join tbl_remedy d on a.id = d.recordNo
                where  a.userid = #{userid} ORDER BY a.createDate DESC limit #{pageNum},#{pageSize}
    </select>

    <!--取消请假申请-->
    <update id="cancelApply" parameterType="String"  >
        UPDATE tbl_leave_record SET  disable = '1' WHERE id = #{applyId}
    </update>

    <!--取消请假审批人-->
    <update id="cancelApplyAudit" parameterType="String" >
        UPDATE tbl_leave_audit_record SET disable = '1' where recordNo = #{applyId}
    </update>

    <!--查询工作提醒-->
    <select id="getLeaveRecord" parameterType="String" resultType="Map">
        select a.userid,a.reason,a.createDate,b.user_name,a.type  from tbl_leave_record a left join tbl_users b on a.userid = b.user_id
        where a.disable = '0' and a.status = '0' and a.userid = #{userId} order by a.createDate DESC
    </select>

    <!--获取待审批记录数量-->
    <select id="getPendingRecord" parameterType="String" resultType="java.util.HashMap">
        select createDate,status from tbl_leave_record  where status = '0' and auditor like concat('%',#{userId},'%') order by  createDate DESC
    </select>

    <!--获取已审批记录数量-->
    <select id="getAlreadyRecord" parameterType="String" resultType="java.util.HashMap">
        select createDate,status from tbl_leave_record  where status &lt;&gt; '0' and auditor like concat('%',#{userId},'%') order by  createDate DESC
    </select>

    <!--获取待审批记录-->
    <select id="queryPeningRecord" parameterType="Map" resultType="com.ulaiber.web.model.ApplyForVO">
        select a.id,a.leaveType,a.startDate,a.endDate,a.leaveTime,a.auditor,a.reason,a.createDate,a.currentAuditor,a.startType,a.endType,a.restDay,
        a.status,a.disable,a.type,b.holiday,b.mode,c.user_name as username ,c.image ,d.morning,d.afternoon,d.remedyDate,d.type as remedyType
         from tbl_leave_record a left join tbl_overtime_details b on a.id = b.recordNo
        left join tbl_users c on a.userid = c.user_id
        left join tbl_remedy d on a.id = d.recordNo
        where a.disable = '0' and  a.auditor like concat('%',#{userId},'%') and a.id = #{id}
        order by a.createDate desc
    </select>

    <!--获取已审批记录-->
    <select id="queryAlreadRecord" parameterType="Map" resultType="com.ulaiber.web.model.ApplyForVO">
        select a.id,a.leaveType,a.startDate,a.endDate,a.leaveTime,a.auditor,a.reason,a.createDate,a.currentAuditor,a.startType,a.endType,a.restDay,
        a.status,a.disable,a.type,b.holiday,b.mode,c.user_name as username ,c.image,d.morning,d.afternoon,d.remedyDate,d.type as remedyType
        from tbl_leave_record a
        left join tbl_overtime_details b on a.id = b.recordNo
        left join tbl_remedy d on a.id = d.recordNo
        left join tbl_users c on a.userid = c.user_id
        where  a.id in
        <foreach collection="array" item="ids" open="(" separator="," close=")">
            #{ids}
        </foreach>
        order by a.editDate desc
    </select>

    <!--更新申请记录为最新的状态-->
    <update id="updateRecord" parameterType="Map" >
        UPDATE tbl_leave_record set status = #{status},currentAuditor = #{currentAuditor},editDate = #{date} where id = #{recordNo}
    </update>

    <!--根据申请记录ID获取申请记录-->
    <select id="queryApplyRecordById" parameterType="int" resultType="Map">
        select a.reason,a.type,b.user_name from tbl_leave_record a left join tbl_users b on a.userid = b.user_id  where a.id = #{id}
    </select>

    <!--根据日期查询用户-->
    <select id="getUserTotalByDate" parameterType="Map" resultType="int">
        select count(a.user_id) as total from tbl_users a
        left join tbl_roots b on a.user_id = b.userid
        where  b.companyNumber = #{companyNumber}
        <if test='_parameter != "" and _parameter != null'>
            and a.createTime > #{date}
        </if>

    </select>

    <!--根据日期分页查询新增用户-->
    <select id="getUserByDate" parameterType="Map" resultType="com.ulaiber.web.model.User">
        select a.user_id as id,a.user_name as userName,a.image,a.disabled,c.name as dept_name,a.createTime,a.mobile  from tbl_users a
        left join tbl_roots b on a.user_id = b.userid
        left join tbl_departments c on b.dept_number = c.dept_number
        where  a.user_name is not null and b.companyNumber = #{companyNumber}  and a.disabled = '0'
        <if test='date != "" and date != null'>
            and  a.createTime > #{date}
        </if>
        order by a.createTime limit #{pageNum},#{pageSize}
    </select>

    <!--根据日期分页查询删除用户-->
    <select id="getDeleteUserByDate" parameterType="Map" resultType="com.ulaiber.web.model.User">
        select a.user_id as id,a.user_name as userName,a.image,a.disabled,c.name as dept_name,a.createTime,a.mobile  from tbl_users a
        left join tbl_roots b on a.user_id = b.userid
        left join tbl_departments c on b.dept_number = c.dept_number
        where  a.user_name is not null and b.companyNumber = #{companyNumber}  and a.disabled = '1'
        <if test='date != "" and date != null'>
            and  a.createTime > #{date}
        </if>
        order by a.createTime limit #{pageNum},#{pageSize}
    </select>

    <!--修改用户个推CID-->
    <update id="updateUser" parameterType="Map">
        UPDATE tbl_users set CID = #{CID} where user_id = #{userid}
    </update>

    <!--新增申请记录-->
    <insert id="insertRemedyRecord" parameterType="com.ulaiber.web.model.LeaveRecord"  useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tbl_leave_record (userid,auditor,reason,createDate,status,disable,type)
            VALUES (#{userid},#{auditor},#{reason},#{createDate},'0','0','4')
    </insert>

    <!--新增补卡信息-->
    <insert id="addRemedy" parameterType="com.ulaiber.web.model.Remedy" >
        INSERT INTO tbl_remedy (recordNo,morning,afternoon,remedyDate,type)
            VALUES (#{recordNo},#{morning},#{afternoon},#{remedyDate},#{type})
    </insert>

    <!--根据记录Id查询补卡信息-->
    <select id="getRemedyRecordByUserId" parameterType="int" resultType="com.ulaiber.web.model.Remedy">
        SELECT a.*,b.userId FROM tbl_remedy a LEFT join tbl_leave_record b on a.recordNo = b.id
            where a.recordNo = #{recordNo}
    </select>
    
    <!--获取某个公司某个月份所有人的审批通过的请假或加班的总时长  -->
    <select id="getTotalTimeByCompanyNumAndMonth" parameterType="Map" resultType="Map">
    	select l.userId,
    	<if test='type == "0"'>
            l.leaveType,
        </if>
    	sum(l.realLeaveTime) totalTime from tbl_leave_record l join tbl_roots r on l.userId=r.userId 
		where r.disabled = '0' and  r.companyNumber=#{companyNum} and  l.type=#{type} and l.status='1' and l.disable='0' and locate(#{month},l.startDate)>0 group by l.userId
		<if test='type == "0"'>
            ,l.leaveType
        </if>
	</select>
	
	<!--获取某个月份某人的审批通过的请假的总时长  -->
    <select id="getTotalTimeByUserId" resultType="Double">
		select sum(realLeaveTime) totalTime from tbl_leave_record where type='0' and status='1' and disable='0' and locate(#{month},startDate)>0 and userId=#{userId}
	</select>
	
	<!-- 更新实际请假时长 -->
	<update id="updateRealLeaveTime">
		update tbl_leave_record set realLeaveTime=realLeaveTime-#{time} where userId=#{userId} and type='0' and status='1' and disable='0' 
		and startDate&lt;=#{today} and endDate&gt;=#{today}
	</update>
	
	<!-- 查询用户指定日期审批通过的请假记录 -->
	<select id="getLeaveRecordByUserIdAndDate" resultMap="LeaveRecordMap">
		select userId,leaveType,startDate,endDate,leaveTime,realLeaveTime,startType,endType from tbl_leave_record where userId=#{userId} and type='0' and status='1' and disable='0' 
		and startDate&lt;=#{date} and endDate&gt;=#{date}
	</select>
	
	<!-- 查询用户指定日期段是否有审批通过的请假记录 -->
	<select id="getLeaveRecordByUserIdAndDate2" resultMap="LeaveRecordMap">
		select userId,leaveType,startDate,endDate,leaveTime,realLeaveTime,startType,endType from tbl_leave_record where userId=#{userId} and type='0' and disable='0' and status&lt;'2'
		and (startDate&lt;=#{startDate} and endDate&gt;=#{startDate} or startDate&gt;=#{startDate} and endDate&lt;=#{endDate} or startDate&lt;=#{endDate} and endDate&gt;=#{endDate})
	</select>
	
    <!--根据审批状态获取申请记录状态-->
    <select id="queryApplyStatus" parameterType="int" resultType="com.ulaiber.web.model.LeaveRecord">
        select disable FROM tbl_leave_record where id = #{recordNo}
    </select>
    
    <!--获取个人申请记录数量-->
    <select id="getLeaveRecordCount" parameterType="Long" resultType="int">
        select COUNT(a.userid) as count from tbl_leave_record a left join tbl_users b on a.userid = b.user_id
        where a.disable = '0' and a.status = '0' and a.userid = #{userId} order by a.createDate DESC
    </select>

    <!--获取个人审批记录数量-->
    <select id="getLeaveAuditorCount" parameterType="Long" resultType="int">
          select COUNT(userid) as count from tbl_leave_audit_record
            WHERE disable = '0' and status = '0' and auditor = #{userId} ORDER BY auditDate DESC
    </select>
</mapper>